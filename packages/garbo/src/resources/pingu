import { Monster, Item, Familiar, myClass, myFury } from "kolmafia";
import { $class, $effect, $familiar, $item, $monsters, $skill, get, getBanishedMonsters, have, Macro } from "libram";

const monsters = $monsters`Copperhead Club bartender, fan dancer, ninja dressed as a waiter, waiter dressed as a ninja`;

export function getMonstersToBanish(): Monster[] {
  const banishedMonsters = getBanishedMonsters();
  const alreadyBanished = Array.from(banishedMonsters.values());
  return monsters.filter((monster) => !alreadyBanished.includes(monster));
}

interface BanishMethod {
  available: () => boolean;
  macro: () => Macro;
  name: string;
  equip?: Item | Familiar;
}

const banishMethods: BanishMethod[] = [
  {
    name: "Monkey Slap",
    available: () => get("_monkeyPawWishesUsed") === 0 && have($item`cursed monkey's paw`),
    macro: () => Macro.trySkill($skill`Monkey Slap`),
    equip: $item`cursed monkey's paw`,
  },
  {
    name: "Spring Kick",
    available: () => have($item`spring shoes`),
    macro: () => Macro.trySkill($skill`Spring Kick`).trySkill($skill`Spring Away`).runaway(),
    equip: $item`spring shoes`
  },
  {
    name: "Batter Up!",
    available: () => myClass() === $class`Seal Clubber` && have($skill`Batter Up!`) && myFury() >= 5,
    macro: () => Macro.trySkill($skill`Batter Up!`),
    equip: $item`seal-clubbing club`
  },
  {
    name: "human musk",
    available: () => true,
    macro: () => Macro.tryItem($item`human musk`),
  },
  {
    name: "Unleash Nanites",
    available: () => have($effect`Nanobrawny`),
    macro: () => Macro.trySkill($skill`Unleash Nanites`),
    equip: have($familiar`Nanorhino`) ? $familiar`Nanorhino` : $familiar`Comma Chameleon`
  },
]

function banishMethodInUse(method: BanishMethod): boolean {
  const banished = getBanishedMonsters();

  for (const [sourceItemOrSkill, banishedMonster] of banished.entries()) {
    if (
      monsters.includes(banishedMonster) && // our critical list
      (
        (method.name === sourceItemOrSkill.name) || // Match by name (item or skill)
        false // you can extend this if necessary
      )
    ) {
      return true;
    }
  }
  return false;
}

export function penguinChooseBanish(): BanishMethod | null {
  for (const method of banishMethods) {
    if (method.available() && !banishMethodInUse(method)) {
      return method;
    }
  }
  return null;
}